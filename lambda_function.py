import json


# We need to use the low-level library to interact with SageMaker since the SageMaker API
# is not available natively through Lambda.
import boto3

# And we need the regular expression library to do some of the data processing
import re

REPLACE_NO_SPACE = re.compile("(\.)|(\;)|(\:)|(\!)|(\')|(\?)|(\,)|(\")|(\()|(\))|(\[)|(\])")
REPLACE_WITH_SPACE = re.compile("(<br\s*/><br\s*/>)|(\-)|(\/)")

def review_to_words(review):
    words = REPLACE_NO_SPACE.sub("", review.lower())
    words = REPLACE_WITH_SPACE.sub(" ", words)
    return words

def bow_encoding(words, vocabulary):
    bow = [0] * len(vocabulary) # Start by setting the count for each word in the vocabulary to zero.
    for word in words.split():  # For each word in the string
        if word in vocabulary:  # If the word is one that occurs in the vocabulary, increase its count.
            bow[vocabulary[word]] += 1
    return bow


def lambda_handler(event, context):

    vocab = {'movi': 2,
 'film': 3,
 'one': 4,
 'like': 5,
 'time': 6,
 'good': 7,
 'make': 8,
 'see': 9,
 'watch': 10,
 'get': 11,
 'even': 12,
 'charact': 13,
 'would': 14,
 'stori': 15,
 'realli': 16,
 'well': 17,
 'much': 18,
 'look': 19,
 'act': 20,
 'end': 21,
 'go': 22,
 'scene': 23,
 'way': 24,
 'also': 25,
 'think': 26,
 'first': 27,
 'great': 28,
 'made': 29,
 'peopl': 30,
 'thing': 31,
 'could': 32,
 'love': 33,
 'bad': 34,
 'play': 35,
 'know': 36,
 'say': 37,
 'show': 38,
 'seen': 39,
 'come': 40,
 'plot': 41,
 'work': 42,
 'seem': 43,
 'actor': 44,
 'want': 45,
 'take': 46,
 'year': 47,
 'mani': 48,
 'never': 49,
 'two': 50,
 'best': 51,
 'tri': 52,
 'littl': 53,
 'ever': 54,
 'give': 55,
 'better': 56,
 'life': 57,
 'still': 58,
 'find': 59,
 'someth': 60,
 'back': 61,
 'perform': 62,
 'man': 63,
 'feel': 64,
 'part': 65,
 'actual': 66,
 'director': 67,
 'interest': 68,
 'use': 69,
 'lot': 70,
 'cast': 71,
 'real': 72,
 'anoth': 73,
 'though': 74,
 'enjoy': 75,
 'old': 76,
 'noth': 77,
 'live': 78,
 '10': 79,
 'set': 80,
 'start': 81,
 'point': 82,
 'star': 83,
 'everi': 84,
 'believ': 85,
 'turn': 86,
 'new': 87,
 'day': 88,
 'direct': 89,
 'thought': 90,
 'role': 91,
 'funni': 92,
 'quit': 93,
 'fact': 94,
 'wonder': 95,
 'got': 96,
 'long': 97,
 'guy': 98,
 'around': 99,
 'world': 100,
 'right': 101,
 'howev': 102,
 'minut': 103,
 'happen': 104,
 'pretti': 105,
 'enough': 106,
 'effect': 107,
 'music': 108,
 'line': 109,
 'origin': 110,
 'without': 111,
 'big': 112,
 'need': 113,
 'must': 114,
 'bit': 115,
 'script': 116,
 'saw': 117,
 'us': 118,
 'put': 119,
 'girl': 120,
 'reason': 121,
 'young': 122,
 'least': 123,
 'fan': 124,
 'sure': 125,
 'alway': 126,
 'may': 127,
 'person': 128,
 'almost': 129,
 'done': 130,
 'tell': 131,
 'last': 132,
 'whole': 133,
 'becom': 134,
 'final': 135,
 'action': 136,
 'complet': 137,
 'anyth': 138,
 'beauti': 139,
 'far': 140,
 'place': 141,
 'comedi': 142,
 'kill': 143,
 'friend': 144,
 'sinc': 145,
 'mean': 146,
 'expect': 147,
 'kind': 148,
 'begin': 149,
 'probabl': 150,
 'might': 151,
 'entertain': 152,
 'away': 153,
 'differ': 154,
 'let': 155,
 'call': 156,
 'hard': 157,
 'name': 158,
 'laugh': 159,
 'anyon': 160,
 'help': 161,
 'screen': 162,
 'shot': 163,
 'lead': 164,
 'especi': 165,
 '2': 166,
 'yet': 167,
 'worst': 168,
 'famili': 169,
 'run': 170,
 'found': 171,
 'rather': 172,
 'moment': 173,
 'keep': 174,
 'hope': 175,
 'read': 176,
 'cours': 177,
 'although': 178,
 'horror': 179,
 'recommend': 180,
 'idea': 181,
 'goe': 182,
 'appear': 183,
 'fun': 184,
 'audienc': 185,
 'woman': 186,
 'tv': 187,
 'bore': 188,
 'worth': 189,
 'mind': 190,
 'move': 191,
 'kid': 192,
 'sens': 193,
 'job': 194,
 'everyth': 195,
 'someon': 196,
 'follow': 197,
 'second': 198,
 'togeth': 199,
 'mayb': 200,
 'true': 201,
 'money': 202,
 'leav': 203,
 'dvd': 204,
 'everyon': 205,
 'face': 206,
 'main': 207,
 'said': 208,
 'seri': 209,
 'instead': 210,
 'excel': 211,
 'wast': 212,
 'special': 213,
 'hand': 214,
 'nice': 215,
 'rate': 216,
 'problem': 217,
 'miss': 218,
 'view': 219,
 'high': 220,
 'american': 221,
 'eye': 222,
 'left': 223,
 'later': 224,
 'els': 225,
 'understand': 226,
 'three': 227,
 'product': 228,
 'night': 229,
 'care': 230,
 'hour': 231,
 'classic': 232,
 'sound': 233,
 'write': 234,
 '1': 235,
 'open': 236,
 'includ': 237,
 'head': 238,
 'surpris': 239,
 'talk': 240,
 'fall': 241,
 'less': 242,
 'review': 243,
 'top': 244,
 'rememb': 245,
 'gener': 246,
 'piec': 247,
 'half': 248,
 'entir': 249,
 'viewer': 250,
 'involv': 251,
 'possibl': 252,
 'chang': 253,
 'usual': 254,
 'book': 255,
 'except': 256,
 'simpli': 257,
 'disappoint': 258,
 'rest': 259,
 'absolut': 260,
 'total': 261,
 'either': 262,
 'death': 263,
 'human': 264,
 'attempt': 265,
 'definit': 266,
 'suppos': 267,
 'wrong': 268,
 'given': 269,
 'die': 270,
 'short': 271,
 'along': 272,
 'wife': 273,
 'coupl': 274,
 'produc': 275,
 'poor': 276,
 'boy': 277,
 'word': 278,
 'john': 279,
 '3': 280,
 'home': 281,
 'pictur': 282,
 'lack': 283,
 'releas': 284,
 'low': 285,
 'portray': 286,
 'featur': 287,
 'full': 288,
 'decid': 289,
 'close': 290,
 'terribl': 291,
 'aw': 292,
 'writer': 293,
 'version': 294,
 'camera': 295,
 'bring': 296,
 'came': 297,
 'hous': 298,
 'talent': 299,
 'budget': 300,
 'truli': 301,
 'hollywood': 302,
 'black': 303,
 'titl': 304,
 'next': 305,
 'save': 306,
 'power': 307,
 'perfect': 308,
 'stupid': 309,
 'father': 310,
 'base': 311,
 'age': 312,
 'case': 313,
 'dead': 314,
 'style': 315,
 'sever': 316,
 'fight': 317,
 'written': 318,
 'sort': 319,
 'video': 320,
 'perhap': 321,
 'other': 322,
 'creat': 323,
 'comment': 324,
 'small': 325,
 'consid': 326,
 'dialogu': 327,
 'heart': 328,
 'unfortun': 329,
 'guess': 330,
 'murder': 331,
 'stop': 332,
 'men': 333,
 'emot': 334,
 'often': 335,
 'develop': 336,
 'imagin': 337,
 'episod': 338,
 'mention': 339,
 'war': 340,
 'meet': 341,
 'exampl': 342,
 'light': 343,
 'earli': 344,
 'anim': 345,
 'experi': 346,
 'flick': 347,
 'lost': 348,
 'actress': 349,
 'ye': 350,
 'support': 351,
 'qualiti': 352,
 'overal': 353,
 'humor': 354,
 'amaz': 355,
 'forc': 356,
 'fail': 357,
 'manag': 358,
 'impress': 359,
 'ask': 360,
 'went': 361,
 'women': 362,
 'basic': 363,
 'stand': 364,
 'felt': 365,
 'certainli': 366,
 'hit': 367,
 'song': 368,
 'drama': 369,
 'school': 370,
 'extrem': 371,
 'natur': 372,
 'wors': 373,
 'cut': 374,
 'throughout': 375,
 'side': 376,
 'joke': 377,
 'sequenc': 378,
 'dark': 379,
 'matter': 380,
 'wait': 381,
 'oh': 382,
 'present': 383,
 'alreadi': 384,
 'favorit': 385,
 'cinema': 386,
 'sex': 387,
 'art': 388,
 'type': 389,
 'despit': 390,
 'realiz': 391,
 'fine': 392,
 'horribl': 393,
 '4': 394,
 'late': 395,
 'success': 396,
 '5': 397,
 'learn': 398,
 'touch': 399,
 'brother': 400,
 'sit': 401,
 'wish': 402,
 'white': 403,
 'past': 404,
 'credit': 405,
 'anyway': 406,
 'deserv': 407,
 'walk': 408,
 'abl': 409,
 'behind': 410,
 'stay': 411,
 'question': 412,
 'mysteri': 413,
 'genr': 414,
 'mother': 415,
 'gave': 416,
 'deal': 417,
 'children': 418,
 'rent': 419,
 'histori': 420,
 'sometim': 421,
 'annoy': 422,
 'number': 423,
 'mr': 424,
 'appar': 425,
 'hate': 426,
 'evil': 427,
 'chanc': 428,
 'today': 429,
 'voic': 430,
 'twist': 431,
 'obvious': 432,
 'add': 433,
 'edit': 434,
 'pleas': 435,
 'soon': 436,
 'killer': 437,
 'continu': 438,
 'relationship': 439,
 'highli': 440,
 'theme': 441,
 'score': 442,
 'slow': 443,
 'b': 444,
 'level': 445,
 'incred': 446,
 'car': 447,
 'figur': 448,
 'decent': 449,
 'stuff': 450,
 'thank': 451,
 'major': 452,
 'hero': 453,
 'ridicul': 454,
 'pace': 455,
 'event': 456,
 'situat': 457,
 'brilliant': 458,
 'son': 459,
 'heard': 460,
 'self': 461,
 'etc': 462,
 'recent': 463,
 'speak': 464,
 'order': 465,
 'took': 466,
 'child': 467,
 'happi': 468,
 'known': 469,
 'break': 470,
 'result': 471,
 'sad': 472,
 'element': 473,
 'obviou': 474,
 'hilari': 475,
 'cannot': 476,
 'compar': 477,
 'import': 478,
 'return': 479,
 'hold': 480,
 'pain': 481,
 'particularli': 482,
 'ago': 483,
 'bodi': 484,
 'predict': 485,
 'career': 486,
 'pick': 487,
 'none': 488,
 'daughter': 489,
 'strang': 490,
 'group': 491,
 'told': 492,
 'god': 493,
 'strong': 494,
 'alon': 495,
 'exist': 496,
 'opinion': 497,
 'comic': 498,
 'town': 499,
 'hear': 500,
 'citi': 501,
 'effort': 502,
 'serious': 503,
 'offer': 504,
 'state': 505,
 'shoot': 506,
 'michael': 507,
 'cinematographi': 508,
 'taken': 509,
 'note': 510,
 'avoid': 511,
 'caus': 512,
 'blood': 513,
 'valu': 514,
 'convinc': 515,
 'exactli': 516,
 'hell': 517,
 'explain': 518,
 'buy': 519,
 'simpl': 520,
 'huge': 521,
 'allow': 522,
 'excit': 523,
 'somewhat': 524,
 'theater': 525,
 'deliv': 526,
 'similar': 527,
 'middl': 528,
 'seriou': 529,
 'critic': 530,
 'countri': 531,
 'across': 532,
 'crap': 533,
 'violenc': 534,
 'check': 535,
 'clich': 536,
 'pass': 537,
 'visual': 538,
 'femal': 539,
 'unlik': 540,
 'ladi': 541,
 'game': 542,
 'form': 543,
 'ok': 544,
 'dream': 545,
 'shown': 546,
 'robert': 547,
 'attent': 548,
 'local': 549,
 'singl': 550,
 'apart': 551,
 'provid': 552,
 'silli': 553,
 'mostli': 554,
 'suspens': 555,
 'prove': 556,
 'win': 557,
 'pull': 558,
 'whose': 559,
 'due': 560,
 'realiti': 561,
 'cool': 562,
 'pay': 563,
 'toward': 564,
 'room': 565,
 'danc': 566,
 'remind': 567,
 'charm': 568,
 'confus': 569,
 'fill': 570,
 'shock': 571,
 'non': 572,
 'carri': 573,
 'respect': 574,
 '7': 575,
 'class': 576,
 'spoiler': 577,
 'husband': 578,
 'easili': 579,
 'thriller': 580,
 'knew': 581,
 'doubt': 582,
 'typic': 583,
 'modern': 584,
 '8': 585,
 'beyond': 586,
 'clearli': 587,
 'subject': 588,
 'fast': 589,
 'cover': 590,
 'intellig': 591,
 'five': 592,
 'cheap': 593,
 'weak': 594,
 'jame': 595,
 'dialog': 596,
 'build': 597,
 'detail': 598,
 'near': 599,
 'polic': 600,
 'english': 601,
 'atmospher': 602,
 'whether': 603,
 'upon': 604,
 'offic': 605,
 'fit': 606,
 'posit': 607,
 'gore': 608,
 'appreci': 609,
 'aspect': 610,
 'spend': 611,
 'date': 612,
 'futur': 613,
 'filmmak': 614,
 'tale': 615,
 'scari': 616,
 'forget': 617,
 'messag': 618,
 'marri': 619,
 'straight': 620,
 'member': 621,
 'sexual': 622,
 'street': 623,
 'discov': 624,
 'ten': 625,
 'oscar': 626,
 'fantast': 627,
 'finish': 628,
 'period': 629,
 'novel': 630,
 'remain': 631,
 'televis': 632,
 'within': 633,
 'four': 634,
 'clear': 635,
 'captur': 636,
 'sequel': 637,
 'nearli': 638,
 'escap': 639,
 'sister': 640,
 'materi': 641,
 'stage': 642,
 'david': 643,
 'standard': 644,
 'plan': 645,
 'easi': 646,
 'air': 647,
 'agre': 648,
 'rock': 649,
 'notic': 650,
 'ad': 651,
 'adult': 652,
 '80': 653,
 'mess': 654,
 'bunch': 655,
 'storylin': 656,
 'drive': 657,
 'polit': 658,
 'parent': 659,
 'lose': 660,
 'suffer': 661,
 'dull': 662,
 'artist': 663,
 'imag': 664,
 'fire': 665,
 'inspir': 666,
 'william': 667,
 'sorri': 668,
 'among': 669,
 'richard': 670,
 'larg': 671,
 'villain': 672,
 'realist': 673,
 'eventu': 674,
 'busi': 675,
 'contain': 676,
 'crime': 677,
 'ultim': 678,
 'list': 679,
 'suggest': 680,
 'mark': 681,
 'romant': 682,
 'dramat': 683,
 'troubl': 684,
 'color': 685,
 'certain': 686,
 'gone': 687,
 'normal': 688,
 'rare': 689,
 'third': 690,
 'kept': 691,
 'accept': 692,
 'brought': 693,
 'admit': 694,
 'somehow': 695,
 'particular': 696,
 'soundtrack': 697,
 'forward': 698,
 'whatev': 699,
 'famou': 700,
 'mix': 701,
 'throw': 702,
 'victim': 703,
 'describ': 704,
 'appeal': 705,
 'premis': 706,
 'documentari': 707,
 'georg': 708,
 'earth': 709,
 'team': 710,
 'pure': 711,
 'sing': 712,
 '9': 713,
 'truth': 714,
 'box': 715,
 'e': 716,
 'shame': 717,
 'british': 718,
 'cri': 719,
 '20': 720,
 'memor': 721,
 'attract': 722,
 'gun': 723,
 'treat': 724,
 'background': 725,
 'free': 726,
 'wit': 727,
 'greatest': 728,
 'averag': 729,
 'lame': 730,
 '30': 731,
 'unless': 732,
 'relat': 733,
 'reveal': 734,
 'potenti': 735,
 'chase': 736,
 'inde': 737,
 'screenplay': 738,
 'attack': 739,
 'romanc': 740,
 'otherwis': 741,
 'warn': 742,
 'amus': 743,
 'locat': 744,
 'choic': 745,
 'peter': 746,
 'masterpiec': 747,
 'difficult': 748,
 'paul': 749,
 'becam': 750,
 'king': 751,
 'adapt': 752,
 'copi': 753,
 'male': 754,
 'suck': 755,
 'cop': 756,
 'adventur': 757,
 'poorli': 758,
 'imdb': 759,
 'okay': 760,
 'dog': 761,
 'uniqu': 762,
 'america': 763,
 'fear': 764,
 'bother': 765,
 'superb': 766,
 'monster': 767,
 'york': 768,
 'teenag': 769,
 'deep': 770,
 'crazi': 771,
 'project': 772,
 'battl': 773,
 'refer': 774,
 'design': 775,
 'red': 776,
 'earlier': 777,
 'odd': 778,
 '70': 779,
 'costum': 780,
 'secret': 781,
 'catch': 782,
 'express': 783,
 'issu': 784,
 'spirit': 785,
 'master': 786,
 'grow': 787,
 'weird': 788,
 'space': 789,
 'hot': 790,
 'wear': 791,
 'jump': 792,
 'execut': 793,
 'scare': 794,
 'stick': 795,
 'equal': 796,
 'quickli': 797,
 'struggl': 798,
 'train': 799,
 'jack': 800,
 'combin': 801,
 'front': 802,
 'badli': 803,
 'perfectli': 804,
 'accent': 805,
 'older': 806,
 'control': 807,
 'plenti': 808,
 'public': 809,
 'roll': 810,
 'flaw': 811,
 'bill': 812,
 'popular': 813,
 'girlfriend': 814,
 'cheesi': 815,
 'bare': 816,
 'lover': 817,
 'season': 818,
 'cultur': 819,
 'societi': 820,
 'week': 821,
 'outsid': 822,
 'previou': 823,
 'scream': 824,
 'maker': 825,
 'magic': 826,
 '90': 827,
 'plu': 828,
 'student': 829,
 'concern': 830,
 'connect': 831,
 'listen': 832,
 'co': 833,
 'babi': 834,
 'award': 835,
 'depict': 836,
 'serv': 837,
 'mistak': 838,
 'concept': 839,
 'drug': 840,
 'term': 841,
 'meant': 842,
 'hardli': 843,
 'amount': 844,
 'fiction': 845,
 'desper': 846,
 'promis': 847,
 'studio': 848,
 'french': 849,
 'plain': 850,
 'creepi': 851,
 'fantasi': 852,
 'parti': 853,
 'era': 854,
 'insid': 855,
 'ride': 856,
 'dumb': 857,
 'flat': 858,
 'rich': 859,
 'innoc': 860,
 'variou': 861,
 'water': 862,
 'sweet': 863,
 'tast': 864,
 'steal': 865,
 'intent': 866,
 'fairli': 867,
 'purpos': 868,
 'dress': 869,
 'lie': 870,
 'tom': 871,
 'social': 872,
 'track': 873,
 'familiar': 874,
 'store': 875,
 'beat': 876,
 'sadli': 877,
 'spot': 878,
 'fli': 879,
 'post': 880,
 'cute': 881,
 'hair': 882,
 'wrote': 883,
 'moral': 884,
 'surviv': 885,
 'mad': 886,
 'engag': 887,
 'stereotyp': 888,
 'share': 889,
 'liter': 890,
 'disturb': 891,
 'memori': 892,
 'unbeliev': 893,
 'answer': 894,
 'c': 895,
 'ruin': 896,
 '50': 897,
 'manner': 898,
 'fascin': 899,
 'collect': 900,
 'fashion': 901,
 'depth': 902,
 'achiev': 903,
 'remark': 904,
 'intrigu': 905,
 'tone': 906,
 'reach': 907,
 'caught': 908,
 'clever': 909,
 'ignor': 910,
 'danger': 911,
 'slightli': 912,
 'conclus': 913,
 'eat': 914,
 'sleep': 915,
 'inform': 916,
 'land': 917,
 'abil': 918,
 'spent': 919,
 'claim': 920,
 'kick': 921,
 'languag': 922,
 'compani': 923,
 'neither': 924,
 'imposs': 925,
 'centuri': 926,
 'rip': 927,
 'doctor': 928,
 'brain': 929,
 'western': 930,
 'delight': 931,
 'tension': 932,
 'limit': 933,
 'nuditi': 934,
 'immedi': 935,
 'de': 936,
 'introduc': 937,
 'record': 938,
 'destroy': 939,
 'suit': 940,
 'extra': 941,
 'dr': 942,
 'cold': 943,
 'law': 944,
 'embarrass': 945,
 'remak': 946,
 'receiv': 947,
 'respons': 948,
 'mere': 949,
 'mari': 950,
 'step': 951,
 'lee': 952,
 'intens': 953,
 'drop': 954,
 'travel': 955,
 'footag': 956,
 'trip': 957,
 'suddenli': 958,
 'biggest': 959,
 'violent': 960,
 'skill': 961,
 '6': 962,
 'player': 963,
 'wood': 964,
 'crew': 965,
 'fi': 966,
 'trash': 967,
 'common': 968,
 '15': 969,
 'complex': 970,
 'pop': 971,
 'sci': 972,
 'univers': 973,
 'approach': 974,
 'handl': 975,
 'drag': 976,
 'mental': 977,
 'fair': 978,
 'physic': 979,
 'soul': 980,
 'genuin': 981,
 'channel': 982,
 'match': 983,
 'solid': 984,
 'bizarr': 985,
 'addit': 986,
 'laughabl': 987,
 'sick': 988,
 'excus': 989,
 'pointless': 990,
 'million': 991,
 'focu': 992,
 'commun': 993,
 'soldier': 994,
 'door': 995,
 'stun': 996,
 'former': 997,
 'edg': 998,
 'suspect': 999,
 'sign': 1000,
 'besid': 1001,
 }

    words = review_to_words(event['body'])
    bow = bow_encoding(words, vocab)

    # The SageMaker runtime is what allows us to invoke the endpoint that we've created.
    runtime = boto3.Session().client('sagemaker-runtime')

    # Now we use the SageMaker runtime to invoke our endpoint, sending the review we were given
    response = runtime.invoke_endpoint(EndpointName = 'sagemaker-pytorch-2021-02-07-09-03-18-172',# The name of the endpoint we created
                                       ContentType = 'text/csv',                 # The data format that is expected
                                       Body = ','.join([str(val) for val in bow]).encode('utf-8')) # The actual review

    # The response is an HTTP response whose body contains the result of our inference
    result = response['Body'].read().decode('utf-8')

    # Round the result so that our web app only gets '1' or '0' as a response.
    result = round(float(result))

    return {
        'statusCode' : 200,
        'headers' : { 'Content-Type' : 'text/plain', 'Access-Control-Allow-Origin' : '*' },
        'body' : str(result)
    }
